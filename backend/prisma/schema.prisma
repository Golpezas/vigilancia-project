// prisma/schema.prisma - Fase 2: Multi-servicio con puntos personalizados
// Mejores prácticas 2026: Relación many-to-many explícita (tabla intermedia), auditoría automática, índices optimizados

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Servicio {
  id        String          @id @default(uuid())
  nombre    String          @unique
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  vigiladores Vigilador[]
  puntos    ServicioPunto[]
  registros Registro[]      // ← NUEVO: relación opuesta obligatoria para Prisma
  
  @@map("servicio")
}

model Vigilador {
  id           String    @id @default(uuid())
  nombre       String
  legajo       Int       @unique
  ultimoPunto  Int       @default(0)
  rondaActiva  Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  servicioId   String
  servicio     Servicio  @relation(fields: [servicioId], references: [id])

  registros    Registro[]

  @@map("vigilador")
}

model Punto {
  id        Int       @id @default(autoincrement())
  nombre    String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  registros Registro[]
  servicios ServicioPunto[]  // ← Relación opuesta completa

  @@map("punto")
}

model ServicioPunto {
  servicioId String
  puntoId    Int

  servicio   Servicio @relation(fields: [servicioId], references: [id])
  punto      Punto    @relation(fields: [puntoId], references: [id])

  @@id([servicioId, puntoId])  // Clave compuesta
  @@map("servicio_punto")
}

model Registro {
  id              String    @id @default(uuid())
  vigiladorId     String
  puntoId         Int
  servicioId      String    // ← NUEVO
  timestamp       DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  geolocalizacion String?
  novedades       String?

  vigilador       Vigilador @relation(fields: [vigiladorId], references: [id])
  punto           Punto     @relation(fields: [puntoId], references: [id])
  servicio        Servicio  @relation(fields: [servicioId], references: [id])  // ← NUEVO

  @@index([vigiladorId, timestamp])
  @@index([vigiladorId, createdAt])
  @@index([servicioId])  // ← NUEVO: para filtros por cliente
  @@map("registro")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed con bcrypt
  role      Role     @default(ADMIN)  // Enum para roles
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user")
}

enum Role {
  ADMIN
  CLIENT
}